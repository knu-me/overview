<script>
(async () => {
  const LIST_URL = 'https://home.knu.ac.kr/HOME/me/sub.htm?nav_code=me1623370434';
  const PROXY = (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`;

  const feedEl = document.getElementById('feed');
  const searchInput = document.getElementById('search');

  function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild; }
  function strip(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function summarize(txt, n=200){
    const t = strip(txt);
    return t.length <= n ? t : t.slice(0, n).replace(/\.+[^.]*$/,'') + '...';
  }

  async function fetchHTML(url){
    const r = await fetch(PROXY(url));
    if(!r.ok) throw new Error('fetch failed');
    const data = await r.json();
    return new DOMParser().parseFromString(data.contents, 'text/html');
  }

  function pickDateAround(node){
    const text = strip(node?.textContent || '');
    const m = text.match(/\d{4}[-.\/]\d{2}[-.\/]\d{2}/);
    return m ? m[0].replace(/[.\/]/g,'-') : null;
  }

  function abs(base, href){
    try { return new URL(href, base).toString(); } catch { return href; }
  }

  async function parseList(){
    const doc = await fetchHTML(LIST_URL);
    const anchors = Array.from(doc.querySelectorAll('a[href*="mode=view"]'));
    // 중복/광고 방지 & 상위 12개만
    const items = [];
    for(const a of anchors){
      const href = abs(LIST_URL, a.getAttribute('href'));
      const title = strip(a.textContent);
      if(!title || items.find(x=>x.url===href)) continue;
      const date = pickDateAround(a.closest('tr') || a.parentElement || a);
      items.push({ title, url: href, date });
      if(items.length >= 12) break;
    }
    return items;
  }

  async function enrich(item){
    try{
      const doc = await fetchHTML(item.url);
      // 본문 텍스트
      const bodySel =
        doc.querySelector('.contents, .board_view, .board, article, #content, .sub_body') || doc.body;
      const desc = summarize(bodySel ? bodySel.textContent : '', 220);

      // 첫 이미지
      const imgEl = doc.querySelector('.board_view img, .contents img, article img, #content img, img');
      const img = imgEl ? abs(item.url, imgEl.getAttribute('src')) : null;

      return { ...item, desc, img, date: item.date || new Date().toISOString().slice(0,10) };
    }catch{
      return { ...item, desc: '', img: null, date: item.date || '' };
    }
  }

  function render(items){
    feedEl.innerHTML = '';
    items.forEach(it => {
      feedEl.appendChild(el(`
        <article class="bg-white rounded-xl shadow hover:shadow-md transition overflow-hidden">
          ${it.img ? `<img src="${it.img}" alt="" class="w-full h-40 object-cover" />` : ``}
          <div class="p-4">
            <h2 class="font-semibold text-lg mb-2">${it.title}</h2>
            <p class="text-sm text-gray-600 mb-3">${it.desc || ''}</p>
            <div class="flex justify-between items-center text-xs text-gray-500">
              <span>${it.date || ''}</span>
              <a href="${it.url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">자세히 보기</a>
            </div>
          </div>
        </article>
      `));
    });
  }

  // 1) 목록 → 2) 상세(병렬) → 3) 렌더
  try{
    const list = await parseList();
    const enriched = await Promise.all(list.map(enrich));
    // 날짜가 있으면 최신순
    enriched.sort((a,b)=> new Date(b.date) - new Date(a.date));
    render(enriched);

    // 검색(기존 UI 유지)
    const articles = () => Array.from(document.querySelectorAll('#feed article'));
    searchInput?.addEventListener('input', () => {
      const keyword = searchInput.value.toLowerCase();
      articles().forEach(article => {
        const text = article.innerText.toLowerCase();
        article.style.display = text.includes(keyword) ? '' : 'none';
      });
    });
  } catch(e){
    console.warn('피드 로딩 실패:', e);
  }
})();
</script>
